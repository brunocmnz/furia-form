<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Verifica√ß√£o de Documento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f5f5f5;
        }

        .container {
            max-width: 600px;
            margin-top: 4em;
        }
    </style>

    <!-- Acrescente no <head> os scripts do Firebase compat -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBzeASdT3iyjzfbffavztJvCuw-SbUsylc",
            authDomain: "furia-form.firebaseapp.com",
            projectId: "furia-form",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

</head>

<body>
    <div class="container card shadow p-4">
        <h3 class="mb-4 text-center">Verifica√ß√£o de Identidade</h3>
        <p>Envie uma imagem n√≠tida do seu RG ou CNH. A IA tentar√° extrair o CPF e comparar com o cadastro.</p>

        <form id="uploadForm">
            <input type="hidden" id="cpfOculto" value="" />
            <div class="mb-3">
                <label for="documento" class="form-label">Imagem do documento</label>
                <input class="form-control" type="file" id="documento" accept="image/*" required />
            </div>
            <button type="submit" class="btn btn-primary w-100">Analisar Documento</button>
        </form>

        <div id="resultadoIA" class="mt-4 d-none">
            <h5>üîç Resultado da An√°lise:</h5>
            <pre id="iaOutput" class="bg-light p-3 rounded border"></pre>
        </div>
    </div>

    <script>
        const validarCPF = (cpf) => {
            cpf = cpf.replace(/[^\d]+/g, '');
            if (cpf.length !== 11 || /^(\d)\1+$/.test(cpf)) return false;
            let soma = 0;
            for (let i = 0; i < 9; i++) soma += parseInt(cpf.charAt(i)) * (10 - i);
            let resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            if (resto !== parseInt(cpf.charAt(9))) return false;
            soma = 0;
            for (let i = 0; i < 10; i++) soma += parseInt(cpf.charAt(i)) * (11 - i);
            resto = (soma * 10) % 11;
            if (resto === 10 || resto === 11) resto = 0;
            return resto === parseInt(cpf.charAt(10));
        };

        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            const cpf = urlParams.get("cpf") || "";
            document.getElementById("cpfOculto").value = cpf;

            document.getElementById("uploadForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const fileInput = document.getElementById("documento");
                const file = fileInput.files[0];
                const cpfEsperado = document.getElementById("cpfOculto").value.replace(/\D/g, "");

                if (!file) {
                    alert("Selecione um arquivo.");
                    return;
                }

                const formData = new FormData();
                formData.append("apikey", "helloworld"); // Free API Key da OCR.space
                formData.append("language", "por");
                formData.append("isOverlayRequired", "false");
                formData.append("file", file);

                try {
                    const response = await fetch("https://api.ocr.space/parse/image", {
                        method: "POST",
                        body: formData,
                    });

                    const result = await response.json();
                    const texto = result?.ParsedResults?.[0]?.ParsedText || "";

                    // Extrair CPF v√°lido
                    const encontrados = texto.match(/\d{3}\.?\d{3}\.?\d{3}-?\d{2}/g) || [];
                    let cpfExtraido = "";

                    for (const item of encontrados) {
                        const somenteNumeros = item.replace(/\D/g, "");
                        if (validarCPF(somenteNumeros)) {
                            cpfExtraido = somenteNumeros;
                            break;
                        }
                    }

                    const divResultado = document.getElementById("resultadoIA");
                    const output = document.getElementById("iaOutput");
                    divResultado.classList.remove("d-none");

                    if (!cpfExtraido) {
                        output.textContent = "‚ùå Nenhum CPF v√°lido foi detectado na imagem.";
                    } else if (cpfExtraido === cpfEsperado) {
                        output.textContent = `‚úÖ CPF reconhecido: ${cpfExtraido}\n‚úîÔ∏è Compat√≠vel com o CPF do cadastro.`;
                        // Atualiza no Firebase
                        try {
                            const query = await db
                                .collection("cadastros")
                                .where("cpf", "==", cpf)
                                .get();
                            if (!query.empty) {
                                await query.docs[0].ref.update({
                                    verificacaoDocumento: "verificado",
                                    verificadoEm: new Date()
                                });
                                output.textContent += "\n‚úÖ Status atualizado no Firebase: verificado";
                            } else {
                                output.textContent += "\n‚ö†Ô∏è Cadastro com este CPF n√£o encontrado no Firestore.";
                            }
                        } catch (firebaseErr) {
                            console.error("Erro ao atualizar Firebase:", firebaseErr);
                            output.textContent += "\n‚ùå Erro ao atualizar status no Firebase.";
                        }

                    } else {
                        output.textContent = `‚ö†Ô∏è CPF reconhecido: ${cpfExtraido}\n‚ùå N√£o corresponde ao CPF informado no cadastro (${cpfEsperado}).`;
                    }


                } catch (err) {
                    console.error("Erro na an√°lise OCR:", err);
                    alert("Erro ao processar imagem com IA. Veja o console.");
                }
            });
        });
    </script>
</body>

</html>